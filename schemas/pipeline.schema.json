{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "description": "Schema for IntelliTester pipeline files that orchestrate multiple workflows",
  "type": "object",
  "properties": {
    "name": {
      "description": "The name of the pipeline",
      "type": "string",
      "minLength": 1
    },
    "platform": {
      "description": "The platform to run the pipeline on",
      "default": "web",
      "type": "string",
      "enum": [
        "web",
        "android",
        "ios"
      ]
    },
    "config": {
      "description": "Pipeline-level configuration that applies to all workflows",
      "type": "object",
      "properties": {
        "web": {
          "description": "Web platform configuration for the pipeline",
          "type": "object",
          "properties": {
            "baseUrl": {
              "description": "Base URL for all workflows in this pipeline",
              "type": "string",
              "minLength": 1,
              "format": "uri"
            },
            "browser": {
              "description": "Browser to use for all web tests",
              "type": "string",
              "enum": [
                "chromium",
                "firefox",
                "webkit"
              ]
            },
            "headless": {
              "description": "Run browser in headless mode",
              "type": "boolean"
            }
          },
          "additionalProperties": false
        },
        "appwrite": {
          "description": "Appwrite backend configuration for the pipeline",
          "type": "object",
          "properties": {
            "endpoint": {
              "description": "Appwrite API endpoint",
              "type": "string",
              "minLength": 1,
              "format": "uri"
            },
            "projectId": {
              "description": "Appwrite project ID",
              "type": "string",
              "minLength": 1
            },
            "apiKey": {
              "description": "Appwrite API key",
              "type": "string",
              "minLength": 1
            },
            "cleanup": {
              "description": "Enable automatic cleanup of created resources",
              "default": true,
              "type": "boolean"
            },
            "cleanupOnFailure": {
              "description": "Clean up resources even when workflows fail",
              "default": true,
              "type": "boolean"
            }
          },
          "required": [
            "endpoint",
            "projectId",
            "apiKey",
            "cleanup",
            "cleanupOnFailure"
          ],
          "additionalProperties": false
        },
        "cleanup": {
          "description": "Resource cleanup configuration",
          "type": "object",
          "properties": {
            "provider": {
              "description": "Cleanup provider to use",
              "type": "string"
            },
            "parallel": {
              "description": "Run cleanup tasks in parallel",
              "default": false,
              "type": "boolean"
            },
            "retries": {
              "description": "Number of retry attempts for failed cleanup operations",
              "default": 3,
              "type": "number",
              "minimum": 1,
              "maximum": 10
            },
            "types": {
              "description": "Map resource types to cleanup handler methods",
              "type": "object",
              "propertyNames": {
                "type": "string"
              },
              "additionalProperties": {
                "type": "string"
              }
            },
            "handlers": {
              "description": "Explicit paths to custom cleanup handler files",
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "discover": {
              "description": "Auto-discovery configuration for cleanup handlers",
              "type": "object",
              "properties": {
                "enabled": {
                  "description": "Enable auto-discovery of cleanup handlers",
                  "default": true,
                  "type": "boolean"
                },
                "paths": {
                  "description": "Directories to search for cleanup handlers",
                  "default": [
                    "./tests/cleanup"
                  ],
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "pattern": {
                  "description": "Glob pattern for handler files",
                  "default": "**/*.ts",
                  "type": "string"
                }
              },
              "required": [
                "enabled",
                "paths",
                "pattern"
              ],
              "additionalProperties": false
            },
            "on_failure": {
              "description": "Run cleanup even if pipeline fails",
              "default": true,
              "type": "boolean"
            },
            "scanUntracked": {
              "type": "boolean",
              "description": "Scan for untracked resources using provider heuristics"
            }
          },
          "required": [
            "parallel",
            "retries",
            "on_failure"
          ],
          "additionalProperties": {}
        },
        "webServer": {
          "description": "Configuration for starting a web server before workflows",
          "type": "object",
          "properties": {
            "command": {
              "description": "Command to start the web server",
              "type": "string",
              "minLength": 1
            },
            "auto": {
              "description": "Auto-detect server start command from package.json",
              "type": "boolean"
            },
            "url": {
              "description": "URL to wait for before starting workflows",
              "type": "string",
              "minLength": 1,
              "format": "uri"
            },
            "reuseExistingServer": {
              "description": "Use existing server if already running at the URL",
              "default": true,
              "type": "boolean"
            },
            "timeout": {
              "description": "Timeout in milliseconds to wait for server to start",
              "default": 30000,
              "type": "integer",
              "exclusiveMinimum": 0,
              "maximum": 9007199254740991
            }
          },
          "required": [
            "url",
            "reuseExistingServer",
            "timeout"
          ],
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "on_failure": {
      "description": "Default failure handling for workflows",
      "default": "skip",
      "type": "string",
      "enum": [
        "skip",
        "fail",
        "ignore"
      ]
    },
    "cleanup_on_failure": {
      "description": "Run cleanup even when pipeline fails",
      "default": true,
      "type": "boolean"
    },
    "workflows": {
      "description": "List of workflow files to execute in this pipeline",
      "minItems": 1,
      "type": "array",
      "items": {
        "description": "Reference to a workflow file",
        "type": "object",
        "properties": {
          "file": {
            "description": "Path to the workflow file",
            "type": "string",
            "minLength": 1
          },
          "id": {
            "description": "Optional ID for referencing this workflow in dependencies",
            "type": "string",
            "minLength": 1
          },
          "depends_on": {
            "description": "IDs of workflows that must complete before this one",
            "type": "array",
            "items": {
              "type": "string",
              "minLength": 1
            }
          },
          "on_failure": {
            "description": "How to handle failure of this workflow",
            "type": "string",
            "enum": [
              "skip",
              "fail",
              "ignore"
            ]
          },
          "variables": {
            "description": "Variables to inject or override for this workflow",
            "type": "object",
            "propertyNames": {
              "type": "string"
            },
            "additionalProperties": {
              "type": "string"
            }
          }
        },
        "required": [
          "file"
        ],
        "additionalProperties": false
      }
    }
  },
  "required": [
    "name",
    "platform",
    "on_failure",
    "cleanup_on_failure",
    "workflows"
  ],
  "additionalProperties": false,
  "title": "IntelliTester Pipeline Definition"
}